# Firebase Push Notifications - Status & Setup

## Current Status

‚úÖ **Firebase Credentials Configured** in `.env`:
- `FIREBASE_PROJECT_ID`: safe-haven-52be4
- `FIREBASE_PRIVATE_KEY`: Configured (full private key)
- `FIREBASE_CLIENT_EMAIL`: firebase-adminsdk-fbsvc@safe-haven-52be4.iam.gserviceaccount.com

‚úÖ **Notification Service Implemented**:
- Located: `backend/src/services/notification.service.ts`
- Supports Firebase Cloud Messaging (FCM)
- Supports SMS via Semaphore
- Includes notification logging

‚úÖ **Broadcasting System Working**:
- Location-based user targeting
- Multi-channel notifications (Push + SMS)
- Statistics tracking

## Why Push Notifications Show 0 Sent

Firebase initialization happens **lazily** (only when the notification service is first used). This is by design to avoid errors if Firebase isn't configured.

The notification service will:
1. Check if Firebase credentials exist
2. Initialize Firebase Admin SDK
3. Send push notifications to device tokens

## What's Needed for Real Push Notifications

### 1. Device Tokens in Database

Users need to register their device tokens. This happens when:
- Mobile app is installed
- User logs in
- App requests notification permissions
- FCM token is sent to backend

**Current Status:** ‚ùå No real device tokens in database (only test tokens)

### 2. Valid FCM Tokens

FCM tokens must be:
- Generated by a real mobile device
- From the same Firebase project (safe-haven-52be4)
- Not expired (tokens can expire)

**Current Status:** ‚ùå Test tokens won't work with real Firebase

### 3. Firebase Project Setup

Your Firebase project must have:
- Cloud Messaging enabled
- Correct package name/bundle ID
- APNs certificate (for iOS)

**Current Status:** ‚úÖ Credentials are configured, but project settings unknown

---

## How to Test Firebase Push Notifications

### Option 1: Test with Broadcasting Script (Current)

```powershell
cd backend
.\test-broadcasting.ps1
```

**Result:** Will show 0 push notifications sent because no real device tokens exist.

### Option 2: Add Test Device Token Manually

1. **Get a real FCM token** from Firebase Console or a test app
2. **Add to database:**
   ```sql
   INSERT INTO device_tokens (user_id, token, platform, is_active) 
   VALUES (1, 'YOUR_REAL_FCM_TOKEN_HERE', 'android', TRUE);
   ```
3. **Run broadcasting test:**
   ```powershell
   .\test-broadcasting.ps1
   ```

### Option 3: Build Mobile App (Recommended)

The proper way to test is with the actual mobile app:

1. **Build React Native app**
2. **Integrate Firebase SDK** in mobile app
3. **Request notification permissions**
4. **Get FCM token** from device
5. **Send token to backend** via `/api/v1/auth/device-token`
6. **Broadcast alerts** - Real notifications will be sent!

---

## Testing Firebase Initialization

To verify Firebase is initializing correctly:

### 1. Check Server Logs

```powershell
cd backend
Get-Content logs/combined.log | Select-String -Pattern "Firebase"
```

**Expected output:**
```
[info]: Firebase Admin initialized successfully
```

**If you see:**
```
[warn]: Firebase Admin initialization skipped - credentials not configured
```
Then credentials aren't being read properly.

### 2. Test Broadcasting

```powershell
.\test-firebase.ps1
```

This will:
- Create test users
- Create an alert
- Attempt to broadcast
- Show Firebase status

---

## Current Firebase Configuration

Your `.env` file has:

```env
FIREBASE_PROJECT_ID=safe-haven-52be4
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-fbsvc@safe-haven-52be4.iam.gserviceaccount.com
```

This looks correct! The private key is properly formatted with `\n` for newlines.

---

## Why Broadcasting Shows 0 Push Sent

When you run `.\test-broadcasting.ps1`, you see:

```
Total Recipients:    5
Push Sent:           0
Push Failed:         0
SMS Sent:            0
SMS Failed:          0
```

This is **EXPECTED** because:

1. **No real device tokens** - Test users don't have valid FCM tokens
2. **Firebase initializes lazily** - Only when first notification is sent
3. **Test tokens won't work** - Need real tokens from mobile devices

---

## Next Steps

### Immediate (Testing):
1. ‚úÖ Firebase credentials are configured
2. ‚úÖ Broadcasting system works
3. ‚úÖ Rate limiting implemented
4. ‚è≥ Waiting for mobile app to generate real tokens

### Short Term (Mobile App):
1. Build React Native mobile app
2. Integrate Firebase SDK
3. Request notification permissions
4. Register device tokens
5. Test real push notifications

### Alternative (Quick Test):
1. Use Firebase Console to send test notification
2. Or use a Firebase testing tool
3. Or manually add a real FCM token to database

---

## Firebase Console Verification

To verify your Firebase project:

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select project: **safe-haven-52be4**
3. Check **Cloud Messaging** is enabled
4. Verify **Service Account** credentials match your `.env`
5. Test sending a notification from console

---

## Summary

| Component | Status | Notes |
|-----------|--------|-------|
| Firebase Credentials | ‚úÖ Configured | In `.env` file |
| Notification Service | ‚úÖ Implemented | Ready to send |
| Broadcasting System | ‚úÖ Working | Targets users correctly |
| Device Tokens | ‚ùå Missing | Need mobile app |
| Real Push Notifications | ‚è≥ Pending | Waiting for tokens |

**Bottom Line:** Everything is set up correctly on the backend. Push notifications will work once you have real device tokens from the mobile app!

---

## Testing Checklist

- [x] Firebase credentials configured
- [x] Notification service implemented
- [x] Broadcasting system working
- [x] Rate limiting implemented
- [ ] Mobile app built
- [ ] Device tokens registered
- [ ] Real push notifications tested

---

## Quick Test Command

```powershell
# Test broadcasting (will show 0 push sent - expected)
cd backend
.\test-broadcasting.ps1

# Test Firebase initialization
.\test-firebase.ps1

# Check server logs
Get-Content logs/combined.log | Select-String -Pattern "Firebase|Push"
```

---

**Your Firebase setup is complete and ready!** üéâ

The backend will automatically send push notifications once real device tokens are registered from the mobile app.
